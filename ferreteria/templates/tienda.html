{% extends 'base.html' %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/estyle.css' %}">
{% endblock %}
{% block contenido %}
{% load humanize %}
 
    
<div class="container">
    <div class="row">
        <div class="col-12 align-self-center"><h1 class="display-1">Tienda</h1></div>
            <div class="mb-3">
                <label><strong>Mostrar precios en:</strong></label><br>
                <input type="radio" name="moneda" value="clp" checked> Pesos chilenos (CLP)
                <input type="radio" name="moneda" value="usd"> Dólares (USD)
            </div>
        </div>
    <div class="row">
        <div class="col-8">
            <div class="row" style="padding: 10px 0;">
                <div class="col-12">
                    <div class="row">
                        {% for p in productos %}
                        <div class="col-6">
                            <div class="card" style="height: 20rem; width: 20rem; margin: 5px 0px; display: grid; place-items: center; margin-inline: 1.0rem; padding-block: 0.5rem;">
                                <img src="{{ p.imagen.url }}" class="card-img-top" style=" width: 120px;" >
                                <div class="card-body">
                                    <h5 class="card-title">{{ p.nombre }}</h5>
                                    <p class="card-text">{{ p.categoria }}</p>
                                    <p class="card-text precio-producto" data-precio="{{p.precio}}">${{ p.precio | intcomma}}</p>
                                    <a href="{% url 'add' p.idProducto%}" class="btn btn-success">Agregar al carrito</a>
                                    <a href="{% url 'detalle' p.idProducto %}" class="btn btn-success">Ver detalles</a>
                                    <br>
                                </div> 
                                <br>
                            </div>
                        </div>
                       {% endfor %} 
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            {% include 'carrito.html' %}
        </div>
    </div>


<script>
    // Verificar si las variables están disponibles
    console.log("Valor dólar:", "{{ valor_dolar }}");


    // Guardar en localStorage
    localStorage.setItem("valor_dolar", "{{ valor_dolar }}");
    
    document.addEventListener("DOMContentLoaded", function () {
        const valorDolar = parseFloat(localStorage.getItem("valor_dolar")) || 1;
        const seleccionado = document.querySelector('input[name="moneda"]:checked').value;
        localStorage.setItem("moneda_seleccionada", seleccionado);
        document.querySelectorAll('input[name="moneda"]').forEach(radio => {
        radio.addEventListener("change", function () {
            localStorage.setItem("moneda_seleccionada", this.value);
            console.log("Moneda cambiada a:", this.value);
            });
        });
        
        function formatearMoneda(valor, moneda) {
            if (moneda === "clp") {
                return "$" + valor.toLocaleString("es-CL");
            } else {
                return "US$ " + valor.toFixed(2);
            }
        }

        function actualizarPrecios(moneda) {
            document.querySelectorAll(".precio-producto").forEach(el => {
                const precioCLP = parseFloat(el.dataset.precio);
                const precioUSD = precioCLP / valorDolar;
                el.textContent = formatearMoneda(moneda === "usd" ? precioUSD : precioCLP, moneda);
            });
        }

        document.querySelectorAll("input[name='moneda']").forEach(radio => {
            radio.addEventListener("change", function () {
                actualizarPrecios(this.value);
            });
        });

        // Mostrar en CLP por defecto
        actualizarPrecios("clp");
    });

</script>    
{% endblock %}

